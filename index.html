<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Your French - Quiz Interactif</title>
    <meta name="description" content="Testez votre niveau de fran√ßais avec ce quiz rapide et d√©couvrez votre score !">

    <!-- Meta tags PWA -->
    <meta name="theme-color" content="#111f46">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Test Your French">

    <!-- Manifeste PWA -->
    <link rel="manifest" href="manifest.json">

    <!-- Ic√¥nes -->
    <link rel="icon" href="icons/icon-72x72.png" type="image/png">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">

    <!-- CSS Principal -->
    <link rel="stylesheet" href="style.css">

    <!-- Font Awesome pour les ic√¥nes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Script pour l'enregistrement du Service Worker (Optionnel, si vous utilisez sw.js) -->
    <!-- Vous pouvez le laisser ici ou le d√©placer √† la fin si vous pr√©f√©rez -->
    <script>
        // V√©rifier si les Service Workers sont support√©s
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    // Assurez-vous que le chemin vers sw.js est correct
                    const registration = await navigator.serviceWorker.register('sw.js');
                    console.log('Service Worker enregistr√© avec succ√®s:', registration.scope);
                } catch (error) {
                    console.error('√âchec de l\'enregistrement du Service Worker:', error);
                }
            });
        }
    </script>
</head>
<body>
    <div class="quiz-container">
        <!-- √âcran d'accueil -->
        <div id="welcome-screen" class="screen fade-in">
            <div class="quiz-logo">
                <img src="icons/icon-192x192.png" alt="Test Your French Logo">
            </div>
            <h1>Test Your French</h1>
            <p class="subtitle">D√©couvrez votre niveau de fran√ßais en quelques minutes !</p>
            <div class="test-details">
                <div class="detail-item"><i class="fas fa-check"></i> Grammaire & Vocabulaire</div>
                <div class="detail-item"><i class="fas fa-check"></i> Compr√©hension</div>
                <div class="detail-item"><i class="fas fa-check"></i> Expressions idiomatiques</div>
            </div>
            <div class="mt-6 px-4">
                <p>Ce quiz contient <span id="question-count">0</span> questions √† choix multiples.</p>
                <p>D√©fiez-vous et partagez votre score avec vos amis !</p>
            </div>
            <div class="timer-option">
                <label class="flex-center">
                    <input type="checkbox" id="enable-timer" checked>
                    <span>Activer le chronom√®tre pour plus de challenge</span>
                </label>
            </div>
            <button id="start-btn" class="btn" aria-label="Commencer le quiz">
                <i class="btn-icon fas fa-play"></i>Commencer le Quiz
            </button>
        </div>

        <!-- √âcran du Quiz -->
        <div id="quiz-screen" class="hidden">
            <h1>Quiz de Fran√ßais</h1>

            <div class="timer-container hidden" id="timer-display">
                <div class="timer" aria-live="polite">
                    <i class="fas fa-clock"></i>
                    <span id="timer-value">00:00</span>
                </div>
                <button class="timer-toggle" id="timer-toggle" aria-label="Masquer le chronom√®tre">
                    <i class="fas fa-eye-slash"></i>
                </button>
            </div>

            <div class="progress-container" aria-label="Progression du quiz">
                <div class="progress-bar">
                    <div class="progress" id="progress"></div>
                </div>
                <div class="progress-steps" id="progress-steps" aria-hidden="true">
                    <!-- Les √©tapes seront ajout√©es ici dynamiquement -->
                </div>
            </div>

            <div id="quiz" role="form" tabindex="-1" aria-label="Zone de la question actuelle">
                <!-- Les questions seront ajout√©es ici dynamiquement -->
            </div>

            <div id="feedback" class="feedback-container" aria-live="polite">
                <!-- Le feedback sera ajout√© ici dynamiquement -->
            </div>

            <div class="buttons">
                <div class="button-group">
                    <button id="prev-btn" class="btn btn-secondary" disabled aria-label="Question pr√©c√©dente">
                        <i class="fas fa-arrow-left btn-icon"></i>Pr√©c√©dent
                    </button>
                </div>
                <div class="button-group">
                    <button id="next-btn" class="btn" disabled aria-label="Question suivante">
                        Suivant<i class="fas fa-arrow-right" style="margin-left: 8px;"></i>
                    </button>
                    <button id="submit-btn" class="btn" style="display: none;" aria-label="Terminer le quiz">
                        R√©sultats<i class="fas fa-flag-checkered" style="margin-left: 8px;"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- √âcran des R√©sultats -->
        <div id="result" class="result-container" style="display: none;" tabindex="-1" aria-label="Zone des r√©sultats">
            <h1>R√©sultats du Quiz</h1>
            <div class="score-highlight" aria-live="polite">
                <span id="score">0</span>/<span id="total-questions">0</span>
            </div>

            <div id="score-message" aria-live="polite"></div>

            <div class="stats-container fade-in">
                <h2>Votre Performance</h2>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="accuracy">0%</div>
                        <div class="stat-label">Pr√©cision</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="avg-time">0s</div>
                        <div class="stat-label">Temps moyen / question</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="fastest-answer">0s</div>
                        <div class="stat-label">R√©ponse la plus rapide</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="slowest-answer">0s</div>
                        <div class="stat-label">R√©ponse la plus longue</div>
                    </div>
                </div>
            </div>

            <div class="cta-container fade-in">
                <h3 class="text-center mb-4">Continuez votre progression en fran√ßais</h3>
                <div class="cta-buttons">
                    <a href="https://testyourfrench.com/french-tests-bundle/" target="_blank" rel="noopener" class="cta-button primary">
                        <span class="cta-icon">üîç</span>
                        <div class="cta-content">
                            <span class="cta-title">Quiz Complet de Fran√ßais</span>
                            <span class="cta-desc">Testez vraiment votre niveau avec notre pack complet de tests</span>
                        </div>
                        <span class="cta-arrow">‚Üí</span>
                    </a>
                    <a href="https://testyourfrench.com/travel-to-france-essentials-bundle/" target="_blank" rel="noopener" class="cta-button secondary">
                        <span class="cta-icon">üóº</span>
                        <div class="cta-content">
                            <span class="cta-title">Guide Essentiel de Paris</span>
                            <span class="cta-desc">Tout ce qu'il faut savoir pour votre voyage √† Paris</span>
                        </div>
                        <span class="cta-arrow">‚Üí</span>
                    </a>
                    <a href="https://onlinenewsletter.kit.com/products/10-things-french-b1-exam" target="_blank" rel="noopener" class="cta-button tertiary">
                        <span class="cta-icon">üéì</span>
                        <div class="cta-content">
                            <span class="cta-title">Pr√©parez votre B1</span>
                            <span class="cta-desc">Les 10 cl√©s pour r√©ussir l'examen B1 de fran√ßais</span>
                        </div>
                        <span class="cta-arrow">‚Üí</span>
                    </a>
                </div>
            </div>

            <div id="summary-container" class="summary-container fade-in">
                <h2>D√©tail des r√©ponses</h2>
                <div id="answers-summary">
                    <!-- Le r√©sum√© des r√©ponses sera ajout√© ici dynamiquement -->
                </div>
            </div>

            <div id="certificate" class="certificate hidden fade-in">
                <h2>Certificat de R√©ussite</h2>
                <div class="certificate-content">
                    <p>Ce certificat atteste que</p>
                    <div class="certificate-name" id="participant-name">Participant</div>
                    <p>a compl√©t√© le quiz de fran√ßais avec un score de</p>
                    <div class="certificate-score"><span id="certificate-score">0</span>/<span id="certificate-total">0</span></div>
                    <p class="certificate-date">Date: <span id="certificate-date"></span></p>
                </div>
            </div>

            <div class="social-share fade-in">
                <p class="social-share-title">Partagez votre score :</p>
                <div class="copyable-text-container">
                    <textarea id="share-text" class="copyable-text" readonly aria-label="Texte √† partager">Just took this French quiz and got [SCORE]/[TOTAL]! üá´üá∑ Think you can beat my score? Try it here üëâ www.testyourfrench.com #FrenchChallenge #TestYourSkills</textarea>
                    <button id="copy-btn" class="btn btn-sm" aria-label="Copier le texte de partage">
                        <i class="fas fa-copy"></i> Copier
                    </button>
                </div>
            </div>

            <div class="buttons">
                <div class="button-group">
                    <button id="restart-btn" class="btn btn-success" aria-label="Recommencer le quiz">
                        <i class="fas fa-redo btn-icon"></i>Recommencer
                    </button>
                </div>
                <div class="button-group">
                    <button id="export-btn" class="btn" aria-label="Exporter les r√©sultats">
                        <i class="fas fa-download btn-icon"></i>Exporter
                    </button>
                    <button id="print-btn" class="btn" aria-label="Imprimer le certificat">
                        <i class="fas fa-print btn-icon"></i>Imprimer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="footer-content">
            <a href="https://www.testyourfrench.com" class="footer-logo" target="_blank" rel="noopener">Test Your French</a>
            <p class="footer-text">Made by Test Your French - Am√©liorez votre fran√ßais d√®s aujourd'hui !</p>
        </div>
    </footer>

    <!-- =========== DEBUT DU SCRIPT PRINCIPAL DU QUIZ =========== -->
    <script>
        // Configuration des questions du quiz
        const quizQuestions = [
             {
                question: "How do you say \"My name is\"? (informal)",
                options: ["Je m'appelle", "Je viens vous", "J'ai le nomm√©", "J'ai une montre"],
                correctAnswer: "Je m'appelle",
                explanation: "Literally, \"I call myself\"."
            },
            {
                question: "How do you say \"I'm from New Orleans\"?",
                options: ["J'aime la Nouvelle-Orl√©ans.", "Je habiter Nouvelle-Orl√©ans.", "Je viens de la Nouvelle-Orl√©ans.", "All of the above"],
                correctAnswer: "Je viens de la Nouvelle-Orl√©ans.",
                explanation: "This is the most natural and idiomatic way to say \"I am from New Orleans\" in French. The verb \"venir de\" (to come from) is commonly used to express origin or birthplace.<br><br>\"J'aime la Nouvelle-Orl√©ans\" means \"I love New Orleans.\" This phrase doesn't accurately convey the meaning of \"being from\" a place.<br><br>\"Je habiter √† la Nouvelle-Orl√©ans\" means \"I to inhabit at New Orleans.\" This phrase is not grammatically correct and sounds awkward."
            },
            {
                question: "How do you say \"You're welcome\"?",
                options: ["De rien", "Avec plaisir", "Je vous en prie", "All of the above"],
                correctAnswer: "All of the above",
                explanation: "All the answers are correct.<br><br>\"De rien\" is the most common and casual way to say you're welcome, and it literally means \"it's nothing\".<br><br>\"Avec plaisir\" means with pleasure, and it's a friendly and enthusiastic way to say \"you're welcome\".<br><br>\"Je vous en prie\" is a formal and polite way to say you're welcome, and it literally means \"I beg of you\".<br><br>Cultural insight for \"je vous en prie\": its roots lie in the Middle Ages, likely emerging around the 13th-14th centuries. Back then, \"prier\" (to pray) wasn't just about requesting or begging, it also carried a strong sense of expressing reverence and devotion."
            },
            {
                question: "How do you say \"Good evening\"? (as a hello)",
                options: ["Bonne nuit", "Bonsoir", "Bon apr√®s-midi", "Bonne soir√©e"],
                correctAnswer: "Bonsoir",
                explanation: "\"Bonsoir\" is the correct way to say good evening in French.<br><br>\"Bonne nuit\" means good night, and it's used when you're going to bed or leaving someone for the night.<br><br>\"Bon apr√®s-midi\" means good afternoon.<br><br>\"Bonne soir√©e\" means \"have a good evening\" and specifically conveys the hope that someone has a pleasant evening ahead."
            },
            {
                question: "How do you say \"How are you doing\"? (formal)",
                options: ["Comment allez-vous ?", "√áa boom ?", "C'est beau la vie ?", "All of the above"],
                correctAnswer: "Comment allez-vous ?",
                explanation: "\"Comment allez-vous ?\" is the formal and polite way to ask, and it's used with strangers, acquaintances, or superiors.<br><br>\"√áa boom ?\" is very casual and a bit outdated (not formal).<br><br>\"C'est beau la vie ?\" is informal and friendly, and it's used with friends."
            },
            {
                question: "Listen to this. What is she saying?",
                options: ["Tu viens chez moi ?", "Tu vas loin ?", "Tu viens d'o√π ?", "Tu tiens ton chien ?"],
                correctAnswer: "Tu viens d'o√π ?",
                explanation: "<strong>\"Tu viens d'o√π ?\"</strong> <em>(Where are you from?)</em>",
                audio: "audio/TYF_Lead_6.mp3" // Assurez-vous que ce chemin est correct
            },
            {
                question: "Listen to this. What is she saying?",
                options: ["Tu es √©tudiant ?", "Tu pars o√π ?", "Tu √©tudies √† l'universit√© ?", "Tu as √©tudi√© o√π ?"],
                correctAnswer: "Tu as √©tudi√© o√π ?",
                explanation: "<strong>\"Tu as √©tudi√© o√π ?\"</strong> <em>(Where did you study?)</em>",
                audio: "audio/TYF_Lead_7.mp3" // Assurez-vous que ce chemin est correct
            },
            {
                question: "Bonjour, c'est la premi√®re fois que je viens. Je ________ ? (fill the blank)",
                options: ["veux vous boire la verre ?", "vois la musique est bonne ?", "peux m'asseoir ici", "vous excuse pas du tout ?"],
                correctAnswer: "peux m'asseoir ici",
                explanation: "<strong>\"Bonjour, c'est la premi√®re fois que je viens. Je peux m'asseoir ici ?\"</strong><br><em>(Hello, this is my first time here. May I sit here?)</em><br><br>The other options are not grammatically correct."
            },
            {
                question: "Excusez-moi, je tourne en rond. ___ ? (fill the blank)",
                options: ["Pouvez-vous m'indiquer le chemin pour le Louvre s'il vous plait", "Montrez chemin mus√©e sur carte.", "Je veux Louvre maintenant.", "All of the above"],
                correctAnswer: "Pouvez-vous m'indiquer le chemin pour le Louvre s'il vous plait",
                explanation: "<strong>\"Excusez-moi, je tourne en rond. Pouvez-vous m'indiquer le chemin pour le Louvre s'il vous plait ?\"</strong><br><em>(Excuse me, I'm going round in circles/I'm lost. Could you please show me the way to the Louvre?)</em><br><br>It's the only sentence that is correct grammatically and that is polite and accurate.<br><br>\"Montrez chemin mus√©e carte.\" This is not a question, but rather a request with a list of words and this does not specify which museum.<br><br>\"Je veux Louvre maintenant.\" It doesn't explicitly ask someone to provide guidance on how to get there and it sounds rude.<br><br><strong>Tip:</strong> in France, it is always best to say \"s'il vous plait\" in all your interactions."
            },
            {
                question: "________ m'inscrire √† ce cours. (fill the blank)",
                options: ["Je suis en voiture", "Tu veux le v√©lo pour", "Je cherche un lapin", "Bonjour, j'aimerais"],
                correctAnswer: "Bonjour, j'aimerais",
                explanation: "<strong>\"Bonjour, j'aimerais m'inscrire √† ce cours.\"</strong><br><em>(Hello, I would like to register for this course.)</em><br><br>In French, we use the conditional of \"vouloir\" (to want) to ask for something politely.<br>Example: I would like a coffee."
            }
        ];

        // √âtat du quiz
        let currentQuestion = 0;
        let score = 0;
        let selectedAnswers = [];
        let questionStatus = [];
        let questionTimes = [];
        let startTime = null;
        let timerEnabled = true;
        let timerInterval = null;
        let totalTimeElapsed = 0;

        // √âl√©ments DOM
        const DOM = {
             screens: {
                welcome: document.getElementById('welcome-screen'),
                quiz: document.getElementById('quiz-screen'),
                result: document.getElementById('result')
            },
            quiz: {
                container: document.getElementById('quiz'),
                feedback: document.getElementById('feedback'),
                progress: {
                    bar: document.getElementById('progress'),
                    steps: document.getElementById('progress-steps')
                },
                timer: {
                    container: document.getElementById('timer-display'),
                    value: document.getElementById('timer-value'),
                    toggle: document.getElementById('timer-toggle'),
                    checkbox: document.getElementById('enable-timer')
                }
            },
            results: {
                score: document.getElementById('score'),
                totalQuestions: document.getElementById('total-questions'),
                message: document.getElementById('score-message'),
                summary: document.getElementById('answers-summary'),
                stats: {
                    accuracy: document.getElementById('accuracy'),
                    avgTime: document.getElementById('avg-time'),
                    fastestAnswer: document.getElementById('fastest-answer'),
                    slowestAnswer: document.getElementById('slowest-answer')
                },
                certificate: {
                    container: document.getElementById('certificate'),
                    score: document.getElementById('certificate-score'),
                    total: document.getElementById('certificate-total'),
                    date: document.getElementById('certificate-date'),
                    name: document.getElementById('participant-name')
                },
                shareText: document.getElementById('share-text')
            },
            buttons: {
                start: document.getElementById('start-btn'),
                prev: document.getElementById('prev-btn'),
                next: document.getElementById('next-btn'),
                submit: document.getElementById('submit-btn'),
                restart: document.getElementById('restart-btn'),
                export: document.getElementById('export-btn'),
                print: document.getElementById('print-btn'),
                copy: document.getElementById('copy-btn')
            },
            questionCount: document.getElementById('question-count')
        };

        // Initialisation au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            DOM.questionCount.textContent = quizQuestions.length;
            initializeArrays();
            setupEventListeners();
            DOM.screens.result.style.display = 'none';
            DOM.screens.quiz.classList.add('hidden');
            DOM.screens.welcome.classList.remove('hidden');

            document.querySelectorAll('.fade-in').forEach(el => {
                el.addEventListener('animationend', () => {
                    el.classList.remove('fade-in');
                }, { once: true });
            });
        });

        // Initialise les tableaux d'√©tat
        function initializeArrays() {
            selectedAnswers = Array(quizQuestions.length).fill(null);
            questionStatus = Array(quizQuestions.length).fill(null);
            questionTimes = Array(quizQuestions.length).fill(0);
        }

        // Configure tous les √©couteurs d'√©v√©nements
        function setupEventListeners() {
            DOM.buttons.start.addEventListener('click', initQuiz);
            DOM.buttons.prev.addEventListener('click', goToPreviousQuestion);
            DOM.buttons.next.addEventListener('click', goToNextQuestion);
            DOM.buttons.submit.addEventListener('click', showResults);
            DOM.buttons.restart.addEventListener('click', restartQuiz);
            DOM.buttons.export.addEventListener('click', exportResults);
            DOM.buttons.print.addEventListener('click', printResults);
            DOM.quiz.timer.toggle.addEventListener('click', toggleTimer);
            DOM.quiz.timer.checkbox.addEventListener('change', (e) => {
                timerEnabled = e.target.checked;
                 if (DOM.screens.quiz.classList.contains('hidden')) {
                     if (!timerEnabled) DOM.quiz.timer.container.classList.add('hidden');
                 }
            });
            DOM.buttons.copy.addEventListener('click', copyShareText);
        }

        // D√©marre le quiz
        function initQuiz() {
            currentQuestion = 0;
            score = 0;
            totalTimeElapsed = 0;
            initializeArrays();

            if (timerEnabled) {
                DOM.quiz.timer.container.classList.remove('hidden', 'timer-hidden');
                DOM.quiz.timer.toggle.innerHTML = '<i class="fas fa-eye-slash"></i>';
                startTimer();
            } else {
                DOM.quiz.timer.container.classList.add('hidden');
                stopTimer();
            }

            showQuestion();
            createProgressSteps();
            updateProgressBar();

            DOM.screens.welcome.classList.add('fade-out');
            setTimeout(() => {
                DOM.screens.welcome.classList.add('hidden');
                DOM.screens.welcome.classList.remove('fade-out');
                DOM.screens.quiz.classList.remove('hidden');
                DOM.screens.quiz.classList.add('fade-in');
                DOM.screens.result.style.display = 'none';
                DOM.quiz.container.focus();
            }, 300);

            updateButtons();
        }

        // Fonctions du timer
        function startTimer() {
            if (!timerEnabled) return;
            startTime = new Date();
            totalTimeElapsed = 0;
            questionTimes = Array(quizQuestions.length).fill(0);
            updateTimerDisplay();
            clearInterval(timerInterval);
            timerInterval = setInterval(updateTimerDisplay, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            timerInterval = null;
        }

        function updateTimerDisplay() {
            if (!timerEnabled || startTime === null) {
                if (!DOM.quiz.timer.container.classList.contains('hidden')) {
                    DOM.quiz.timer.value.textContent = '00:00';
                }
                return;
            }

            const now = new Date();
            const currentQuestionTime = Math.floor((now - startTime) / 1000);
            const displayTime = totalTimeElapsed + currentQuestionTime;

            const minutes = Math.floor(displayTime / 60).toString().padStart(2, '0');
            const seconds = (displayTime % 60).toString().padStart(2, '0');
            DOM.quiz.timer.value.textContent = `${minutes}:${seconds}`;
        }

        function recordQuestionTime() {
            if (!timerEnabled || !startTime) return;
            const endTime = new Date();
            const timeTaken = Math.floor((endTime - startTime) / 1000);
            if (questionTimes[currentQuestion] === 0) {
                questionTimes[currentQuestion] = timeTaken > 0 ? timeTaken : 1;
                totalTimeElapsed += questionTimes[currentQuestion];
            }
        }

        function toggleTimer() {
            const timerContainer = DOM.quiz.timer.container;
            const isHidden = timerContainer.classList.toggle('timer-hidden');
            if (isHidden) {
                DOM.quiz.timer.toggle.innerHTML = '<i class="fas fa-eye"></i>';
                DOM.quiz.timer.toggle.setAttribute('aria-label', 'Afficher le chronom√®tre');
            } else {
                DOM.quiz.timer.toggle.innerHTML = '<i class="fas fa-eye-slash"></i>';
                DOM.quiz.timer.toggle.setAttribute('aria-label', 'Masquer le chronom√®tre');
            }
        }

        // Cr√©e les √©tapes de progression
        function createProgressSteps() {
            DOM.quiz.progress.steps.innerHTML = '';
            for (let i = 0; i < quizQuestions.length; i++) {
                const step = document.createElement('div');
                step.className = 'step';
                step.textContent = i + 1;
                step.setAttribute('aria-label', `Question ${i + 1}`);

                if (i === currentQuestion) {
                    step.classList.add('active');
                    step.setAttribute('aria-current', 'true');
                } else if (questionStatus[i] === 'correct') {
                    step.classList.add('completed');
                    step.setAttribute('aria-label', `Question ${i + 1} - Correcte`);
                } else if (questionStatus[i] === 'incorrect') {
                    step.classList.add('error');
                    step.setAttribute('aria-label', `Question ${i + 1} - Incorrecte`);
                } else {
                    step.setAttribute('aria-label', `Question ${i + 1} - Non r√©pondue`);
                }
                DOM.quiz.progress.steps.appendChild(step);
            }
        }

        // Affiche la question actuelle
        function showQuestion() {
             if (timerEnabled && !questionStatus[currentQuestion]) {
                startTime = new Date();
                updateTimerDisplay();
             } else if (!timerEnabled) {
                 startTime = null;
                 updateTimerDisplay();
             }

            const question = quizQuestions[currentQuestion];
            let questionHTML = `
                <fieldset class="question-container fade-in" id="question-${currentQuestion + 1}" aria-labelledby="question-text-${currentQuestion + 1}">
                    <legend class="sr-only">Question ${currentQuestion + 1} sur ${quizQuestions.length}</legend>
                    <p class="question-text" id="question-text-${currentQuestion + 1}">${question.question}</p>
            `;

            if (question.audio) {
                questionHTML += `
                    <div class="audio-container">
                        <audio controls preload="metadata">
                            <source src="${question.audio}" type="audio/mpeg">
                            Votre navigateur ne supporte pas l'√©l√©ment audio.
                        </audio>
                    </div>
                `;
            }

            questionHTML += `<div class="options" role="radiogroup" aria-labelledby="question-text-${currentQuestion + 1}">`;

            question.options.forEach((option, index) => {
                const isSelected = selectedAnswers[currentQuestion] === option;
                let optionClass = 'option';
                let ariaChecked = 'false';
                let tabIndex = questionStatus[currentQuestion] ? '-1' : '0';
                let pointerEvents = questionStatus[currentQuestion] ? 'none' : 'auto';

                if (isSelected) {
                    optionClass += ' selected';
                    ariaChecked = 'true';
                    if (questionStatus[currentQuestion] === 'correct') {
                        optionClass += ' correct';
                    } else if (questionStatus[currentQuestion] === 'incorrect') {
                        optionClass += ' incorrect';
                    }
                } else if (questionStatus[currentQuestion] === 'incorrect' && option === question.correctAnswer) {
                    optionClass += ' correct';
                    tabIndex = '-1';
                    pointerEvents = 'none';
                }

                questionHTML += `
                    <div class="${optionClass}"
                         data-index="${index}"
                         role="radio"
                         aria-checked="${ariaChecked}"
                         tabindex="${tabIndex}"
                         style="pointer-events: ${pointerEvents};">
                        ${option}
                    </div>
                `;
            });

            questionHTML += `</div></fieldset>`;
            DOM.quiz.container.innerHTML = questionHTML;

            DOM.quiz.feedback.classList.remove('visible');
            DOM.quiz.feedback.innerHTML = '';
            if (questionStatus[currentQuestion]) {
                updateFeedback();
            }

            if (!questionStatus[currentQuestion]) {
                attachOptionEventListeners();
            }

            updateButtons();
            updateProgressBar();
            createProgressSteps();

            setTimeout(() => {
                 const focusTarget = DOM.quiz.container.querySelector('.option[tabindex="0"]') || DOM.buttons.next || DOM.buttons.submit;
                 if(focusTarget) focusTarget.focus();
             }, 100);
        }


        // Attache les √©couteurs d'√©v√©nements aux options
        function attachOptionEventListeners() {
            const options = DOM.quiz.container.querySelectorAll('.option');
            options.forEach(option => {
                if(option.getAttribute('tabindex') === '0') {
                    option.addEventListener('click', handleOptionSelection);
                    option.addEventListener('keydown', handleOptionKeydown);
                }
            });
        }

        function removeOptionEventListeners() {
            const options = DOM.quiz.container.querySelectorAll('.option');
            options.forEach(option => {
                option.removeEventListener('click', handleOptionSelection);
                option.removeEventListener('keydown', handleOptionKeydown);
            });
        }

        function handleOptionSelection(event) {
            selectOption(event.target);
        }
        function handleOptionKeydown(event) {
            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                selectOption(event.target);
            }
        }

        // G√®re la s√©lection d'une option
        function selectOption(selectedOptionElement) {
            if (!selectedOptionElement || !selectedOptionElement.classList.contains('option') || questionStatus[currentQuestion]) return;

            recordQuestionTime();
            removeOptionEventListeners();

            const selectedIndex = parseInt(selectedOptionElement.dataset.index);
            const selectedAnswerText = quizQuestions[currentQuestion].options[selectedIndex];
            const correctAnswerText = quizQuestions[currentQuestion].correctAnswer;

            selectedAnswers[currentQuestion] = selectedAnswerText;

            if (selectedAnswerText === correctAnswerText) {
                questionStatus[currentQuestion] = 'correct';
                score++;
            } else {
                questionStatus[currentQuestion] = 'incorrect';
            }

            const allOptions = DOM.quiz.container.querySelectorAll('.option');
            allOptions.forEach(opt => {
                opt.classList.remove('selected');
                opt.setAttribute('aria-checked', 'false');
                opt.setAttribute('tabindex', '-1');
                opt.style.pointerEvents = 'none';
            });

            selectedOptionElement.classList.add('selected');
            selectedOptionElement.setAttribute('aria-checked', 'true');

            if (questionStatus[currentQuestion] === 'correct') {
                selectedOptionElement.classList.add('correct');
            } else {
                selectedOptionElement.classList.add('incorrect');
                allOptions.forEach(opt => {
                    if (opt.textContent.trim() === correctAnswerText.trim()) {
                        opt.classList.add('correct');
                        opt.classList.remove('selected', 'incorrect');
                    }
                });
            }

            updateFeedback();
            updateButtons();
            createProgressSteps();
            updateProgressBar(); // Mettre √† jour la barre apr√®s r√©ponse

            DOM.buttons.next.focus();
        }

        // Met √† jour le feedback apr√®s une r√©ponse
        function updateFeedback() {
            const question = quizQuestions[currentQuestion];
            const status = questionStatus[currentQuestion];
            if (!status) return;

            let feedbackHTML = '';
            if (status === 'correct') {
                feedbackHTML = `
                    <div class="feedback-correct">
                        <h3><i class="fas fa-check-circle"></i> Correct !</h3>
                        <p>${question.explanation || ''}</p>
                    </div>
                `;
            } else {
                feedbackHTML = `
                    <div class="feedback-incorrect">
                        <h3><i class="fas fa-info-circle"></i> Information</h3>
                        <p>La bonne r√©ponse √©tait : <strong>${question.correctAnswer}</strong></p>
                        <p>${question.explanation || ''}</p>
                    </div>
                `;
            }
            DOM.quiz.feedback.innerHTML = feedbackHTML;
            DOM.quiz.feedback.classList.add('visible');
        }

        // Met √† jour l'√©tat des boutons de navigation
        function updateButtons() {
            DOM.buttons.prev.disabled = currentQuestion === 0;
            const isAnswered = selectedAnswers[currentQuestion] !== null;
            DOM.buttons.next.disabled = !isAnswered;

            if (currentQuestion === quizQuestions.length - 1) {
                DOM.buttons.next.style.display = 'none';
                DOM.buttons.submit.style.display = 'inline-flex';
                DOM.buttons.submit.disabled = !isAnswered;
            } else {
                DOM.buttons.next.style.display = 'inline-flex';
                DOM.buttons.submit.style.display = 'none';
            }
        }

        // Met √† jour la barre de progression
        function updateProgressBar() {
            const answeredCount = selectedAnswers.filter(a => a !== null).length;
            const progressPercentage = (answeredCount / quizQuestions.length) * 100;
            DOM.quiz.progress.bar.style.width = `${progressPercentage}%`;
        }

        // Passe √† la question suivante
        function goToNextQuestion() {
            if (currentQuestion < quizQuestions.length - 1) {
                currentQuestion++;
                showQuestion();
            } else if (currentQuestion === quizQuestions.length - 1 && selectedAnswers[currentQuestion] !== null) {
                showResults();
            }
        }

        // Revient √† la question pr√©c√©dente
        function goToPreviousQuestion() {
             if (currentQuestion > 0) {
                 startTime = null;
                 currentQuestion--;
                 showQuestion();
            }
        }

        // Affiche l'√©cran des r√©sultats
        function showResults() {
            stopTimer();
             if (timerEnabled && startTime && questionTimes[currentQuestion] === 0) {
                 recordQuestionTime();
             }

            const accuracy = Math.round((score / quizQuestions.length) * 100);
            const validTimes = questionTimes.filter(t => t > 0);
            const avgTime = validTimes.length ? (validTimes.reduce((a, b) => a + b, 0) / validTimes.length).toFixed(1) : 'N/A';
            const fastest = validTimes.length ? Math.min(...validTimes) : 'N/A';
            const slowest = validTimes.length ? Math.max(...validTimes) : 'N/A';

            DOM.results.score.textContent = score;
            DOM.results.totalQuestions.textContent = quizQuestions.length;
            DOM.results.stats.accuracy.textContent = `${accuracy}%`;
            DOM.results.stats.avgTime.textContent = avgTime !== 'N/A' ? `${avgTime}s` : avgTime;
            DOM.results.stats.fastestAnswer.textContent = fastest !== 'N/A' ? `${fastest}s` : fastest;
            DOM.results.stats.slowestAnswer.textContent = slowest !== 'N/A' ? `${slowest}s` : slowest;

            let message = '';
            if (accuracy === 100) message = "üéâ Excellent ! Score parfait !";
            else if (accuracy >= 80) message = "üëç Tr√®s bien ! Vous ma√Ætrisez bien le sujet.";
            else if (accuracy >= 50) message = "üôÇ Pas mal ! Continuez √† pratiquer.";
            else message = "üí™ Ne baissez pas les bras ! Chaque erreur est une le√ßon.";
            DOM.results.message.innerHTML = `<p>${message}</p>`;

            displaySummary();

            DOM.results.certificate.score.textContent = score;
            DOM.results.certificate.total.textContent = quizQuestions.length;
            DOM.results.certificate.date.textContent = new Date().toLocaleDateString('fr-FR', { year: 'numeric', month: 'long', day: 'numeric' });
            if (score >= Math.ceil(quizQuestions.length * 0.6)) {
                DOM.results.certificate.container.classList.remove('hidden');
            } else {
                DOM.results.certificate.container.classList.add('hidden');
            }

             const shareTextTemplate = `J'ai obtenu ${score}/${quizQuestions.length} (${accuracy}%) au Quiz Test Your French ! üá´üá∑ Essayez-le : https://www.testyourfrench.com #FrenchQuiz #TestYourFrench`;
             DOM.results.shareText.value = shareTextTemplate;

            DOM.screens.quiz.classList.add('fade-out');
            setTimeout(() => {
                DOM.screens.quiz.classList.add('hidden');
                DOM.screens.quiz.classList.remove('fade-out');
                DOM.screens.result.style.display = 'block';
                DOM.screens.result.classList.add('fade-in');
                DOM.screens.result.focus();
            }, 300);
        }

        // G√©n√®re et affiche le r√©sum√© des r√©ponses
        function displaySummary() {
            let summaryHTML = '';
            quizQuestions.forEach((q, index) => {
                const userAnswer = selectedAnswers[index];
                const status = questionStatus[index];
                const isCorrect = status === 'correct';
                const iconClass = isCorrect ? 'fas fa-check-circle correct-answer' : (status === 'incorrect' ? 'fas fa-times-circle wrong-answer' : 'fas fa-minus-circle');
                const answerClass = isCorrect ? 'correct-answer' : (status === 'incorrect' ? 'wrong-answer' : '');

                summaryHTML += `
                    <div class="summary-item">
                        <div class="summary-question">
                           ${index + 1}. ${q.question}
                        </div>
                        <div class="summary-answer ${answerClass}">
                            ${userAnswer !== null ? `<span>${userAnswer}</span>` : 'Non r√©pondu'}
                            <i class="${iconClass}" aria-hidden="true"></i>
                        </div>
                        ${!isCorrect && userAnswer !== null ? `<div class="summary-correct-answer">Bonne r√©ponse: ${q.correctAnswer}</div>` : ''}
                    </div>
                `;
            });
            DOM.results.summary.innerHTML = summaryHTML;
        }

        // Recommence le quiz
        function restartQuiz() {
            DOM.screens.result.classList.add('fade-out');
            setTimeout(() => {
                DOM.screens.result.style.display = 'none';
                DOM.screens.result.classList.remove('fade-out');
                DOM.screens.welcome.classList.remove('hidden');
                DOM.screens.welcome.classList.add('fade-in');
                // Reset checkbox state
                DOM.quiz.timer.checkbox.checked = true;
                timerEnabled = true;
            }, 300);
        }

        // Copie le texte de partage
        async function copyShareText() {
            try {
                await navigator.clipboard.writeText(DOM.results.shareText.value);
                const originalText = DOM.buttons.copy.innerHTML;
                DOM.buttons.copy.innerHTML = '<i class="fas fa-check"></i> Copi√© !';
                DOM.buttons.copy.disabled = true;
                setTimeout(() => {
                    DOM.buttons.copy.innerHTML = originalText;
                    DOM.buttons.copy.disabled = false;
                }, 2000);
            } catch (err) {
                console.error('Erreur de copie:', err);
                 DOM.results.shareText.select();
                 DOM.results.shareText.setSelectionRange(0, 99999);
                 try {
                    document.execCommand('copy');
                     const originalText = DOM.buttons.copy.innerHTML;
                    DOM.buttons.copy.innerHTML = '<i class="fas fa-check"></i> Copi√© !';
                    DOM.buttons.copy.disabled = true;
                    setTimeout(() => {
                        DOM.buttons.copy.innerHTML = originalText;
                        DOM.buttons.copy.disabled = false;
                    }, 2000);
                 } catch (execErr) {
                    alert("Impossible de copier automatiquement. Veuillez copier manuellement le texte.");
                 }
            }
        }


        // Exporte les r√©sultats (simplifi√© en texte)
        function exportResults() {
            let exportText = `R√©sultats du Quiz Fran√ßais - ${new Date().toLocaleString('fr-FR')}\n\n`;
            exportText += `Score Final: ${score}/${quizQuestions.length} (${Math.round((score / quizQuestions.length) * 100)}%)\n`;
             if(timerEnabled) {
                const validTimes = questionTimes.filter(t => t > 0);
                const avgTime = validTimes.length ? (validTimes.reduce((a, b) => a + b, 0) / validTimes.length).toFixed(1) : 'N/A';
                exportText += `Temps moyen par question: ${avgTime !== 'N/A' ? avgTime + 's' : avgTime}\n`;
                exportText += `Temps total: ${totalTimeElapsed}s\n`;
             }
            exportText += `\n--- D√©tail des r√©ponses ---\n`;

            quizQuestions.forEach((q, index) => {
                exportText += `\nQ${index + 1}: ${q.question}\n`;
                exportText += `   Votre r√©ponse: ${selectedAnswers[index] || 'Non r√©pondu'}\n`;
                if (questionStatus[index] === 'incorrect') {
                    exportText += `   Bonne r√©ponse: ${q.correctAnswer}\n`;
                }
                exportText += `   Statut: ${questionStatus[index] === 'correct' ? 'Correct' : (questionStatus[index] === 'incorrect' ? 'Incorrect' : 'Non r√©pondu')}\n`;
                if (timerEnabled && questionTimes[index] > 0) {
                    exportText += `   Temps pris: ${questionTimes[index]}s\n`;
                }
            });

            const blob = new Blob([exportText], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `resultats_quiz_francais_${new Date().toISOString().slice(0,10)}.txt`;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
        }

        // Imprime les r√©sultats/certificat
        function printResults() {
            window.print();
        }

    </script>
    <!-- =========== FIN DU SCRIPT PRINCIPAL DU QUIZ =========== -->

    <!-- Script pour les notifications PWA (Optionnel) -->
    <!-- Le code JS pour g√©rer beforeinstallprompt et les messages SW est inclus ci-dessus -->
    <!-- Vous pouvez ajouter ici le code pour afficher les notifications si n√©cessaire -->

</body>
</html>
